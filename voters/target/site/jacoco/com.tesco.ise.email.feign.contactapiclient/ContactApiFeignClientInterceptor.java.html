<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ContactApiFeignClientInterceptor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">email-service</a> &gt; <a href="index.source.html" class="el_package">com.tesco.ise.email.feign.contactapiclient</a> &gt; <span class="el_source">ContactApiFeignClientInterceptor.java</span></div><h1>ContactApiFeignClientInterceptor.java</h1><pre class="source lang-java linenums">package com.tesco.ise.email.feign.contactapiclient;

import com.tesco.ise.email.security.ValidateTokenRequest;
import feign.RequestInterceptor;
import feign.RequestTemplate;
import java.time.Instant;
import java.util.Base64;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.util.LinkedMultiValueMap;
import org.springframework.util.MultiValueMap;
import org.springframework.web.client.RestTemplate;

/**
 * Feign client interceptor to inject Authorization header to all outbound calls to Contact API
 * Service
 */
// @Profile(&quot;!integration-test&quot;)
@RequiredArgsConstructor
<span class="fc" id="L25">@Slf4j</span>
public class ContactApiFeignClientInterceptor implements RequestInterceptor {

  @Autowired private final RestTemplate restTemplate;

  @Value(&quot;${tesco.oidc.identity.client-id}&quot;)
  private String identityClientId;

  @Value(&quot;${tesco.oidc.identity.client-secret}&quot;)
  private String identityClientSecret;

  @Value(&quot;${tesco.oidc.identity.issue-token-url}&quot;)
  private String identityIssueURL;

  @Value(&quot;${tesco.oidc.identity.grantType}&quot;)
  private String grantType;

  @Value(&quot;${tesco.oidc.identity.scope}&quot;)
  private String scope;

  @Value(&quot;${tesco.oidc.identity.confidence_level}&quot;)
  private String confidenceLevel;

  private ValidateTokenRequest tokenInfo;

  private Instant expiry = Instant.EPOCH;

  /**
   * Get current user token and use it as Authorization header, if token does not exist get a new
   * token using client credentials flow.
   *
   * @param requestTemplate request template
   */
  @Override
  public void apply(RequestTemplate requestTemplate) {
<span class="fc bfc" id="L60" title="All 4 branches covered.">    if (tokenInfo == null || expiry.compareTo(Instant.now()) &lt; 0) {</span>
<span class="fc" id="L61">      HttpHeaders headers = new HttpHeaders();</span>
<span class="fc" id="L62">      headers.add(&quot;Authorization&quot;, generateAuthHeader());</span>

<span class="fc" id="L64">      MultiValueMap&lt;String, String&gt; map = new LinkedMultiValueMap&lt;&gt;();</span>
<span class="fc" id="L65">      map.add(&quot;grant_type&quot;, grantType);</span>
<span class="fc" id="L66">      map.add(&quot;scope&quot;, scope);</span>
<span class="fc" id="L67">      map.add(&quot;confidence_level&quot;, confidenceLevel);</span>
<span class="fc" id="L68">      HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt; entity = new HttpEntity&lt;&gt;(map, headers);</span>
<span class="fc" id="L69">      tokenInfo =</span>
          restTemplate
<span class="fc" id="L71">              .exchange(identityIssueURL, HttpMethod.POST, entity, ValidateTokenRequest.class)</span>
<span class="fc" id="L72">              .getBody();</span>
<span class="fc bfc" id="L73" title="All 2 branches covered.">      if (tokenInfo != null) {</span>
<span class="fc" id="L74">        expiry = Instant.now().plusSeconds(tokenInfo.getExpiresIn());</span>
      } else {
<span class="fc" id="L76">        log.warn(&quot;Error getting identity token. Service might return 401 or 403.&quot;);</span>
<span class="fc" id="L77">        return;</span>
      }
<span class="fc" id="L79">    } else {</span>
<span class="fc" id="L80">      log.debug(&quot;using existing token, expiry: {}&quot;, expiry);</span>
    }
<span class="fc" id="L82">    requestTemplate.header(&quot;Authorization&quot;, String.format(&quot;Bearer %s&quot;, tokenInfo.getAccessToken()));</span>
<span class="fc" id="L83">  }</span>

  public String generateAuthHeader() {
<span class="fc" id="L86">    return String.format(&quot;Basic %s&quot;, generateBase64());</span>
  }

  private String generateBase64() {
<span class="fc" id="L90">    String auth = String.format(&quot;%s:%s&quot;, identityClientId, identityClientSecret);</span>
<span class="fc" id="L91">    return Base64.getEncoder().encodeToString(auth.getBytes());</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>